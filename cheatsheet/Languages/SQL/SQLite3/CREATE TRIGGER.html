<h1>Создание триггеров в SQLite</h1>
<p><strong>Триггер</strong> - это объект базы данных, который автоматически выполняется
при наступлении определённого события (<code>INSERT</code>, <code>UPDATE</code>, <code>DELETE</code>) на заданной таблице
В SQLite триггеры поддерживают различные сценарии, включая до/после событий и проверку условий</p>
<h1>Общий синтаксис</h1>
<div class="code_element"><div class="lang_line"><text>sql</text><button class="copy_code_button" onclick="CopyCode(this)"><svg width="1.2em" height="1.2em" viewBox="0 0 24 24"><use href="#copy_code_svg"/></svg><text class="unselectable">Copy code</text></button></div><div class="code language-sql"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="k">trigger_name</span>
<span class="p">[</span><span class="k">BEFORE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">AFTER</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">INSTEAD</span><span class="w"> </span><span class="k">OF</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="k">INSERT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="p">[</span><span class="k">OF</span><span class="w"> </span><span class="k">column_name</span><span class="p">]]</span>
<span class="k">ON</span><span class="w"> </span><span class="k">table_name</span>
<span class="p">[</span><span class="k">FOR</span><span class="w"> </span><span class="k">EACH</span><span class="w"> </span><span class="k">ROW</span><span class="p">]</span>
<span class="p">[</span><span class="k">WHEN</span><span class="w"> </span><span class="n">condition</span><span class="p">]</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="c1">-- SQL-запросы, которые выполняются в триггере</span>
<span class="k">END</span><span class="p">;</span>
</pre></div></div></div>

<h1>Типы триггеров</h1>
<ol>
<li><code>BEFORE</code> Выполняется перед событием (можно отменить операцию, вызвав ошибку)</li>
<li><code>AFTER</code> Выполняется после события (например, для логирования)</li>
<li><code>INSTEAD OF</code> Заменяет выполнение события (обычно для представлений)</li>
</ol>
<h1>Ключевые аспекты</h1>
<ul>
<li><code>FOR EACH ROW</code>
Указывает, что триггер должен выполняться для каждой строки, затронутой операцией</li>
<li><code>WHEN condition</code>
Добавляет условие для выполнения триггера. Если условие <code>FALSE</code>, триггер не выполняется</li>
<li>Псевдотаблицы<ul>
<li><code>NEW</code>: содержит новые значения (доступно для <code>INSERT</code> и <code>UPDATE</code>)</li>
<li><code>OLD</code>: содержит старые значения (доступно для <code>DELETE</code> и <code>UPDATE</code>)</li>
</ul>
</li>
</ul>
<h1>Примеры использования</h1>
<h3>Логирование вставок</h3>
<p>Логируем время и значение, вставленное в <code>main_table</code></p>
<div class="code_element"><div class="lang_line"><text>sql</text><button class="copy_code_button" onclick="CopyCode(this)"><svg width="1.2em" height="1.2em" viewBox="0 0 24 24"><use href="#copy_code_svg"/></svg><text class="unselectable">Copy code</text></button></div><div class="code language-sql"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">log_table</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="n">AUTOINCREMENT</span><span class="k">,</span>
<span class="w">    </span><span class="n">operation_time</span><span class="w"> </span><span class="nb">TEXT</span><span class="k">,</span>
<span class="w">    </span><span class="n">new_value</span><span class="w"> </span><span class="nb">TEXT</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="n">log_insert_trigger</span>
<span class="k">AFTER</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">main_table</span>
<span class="k">FOR</span><span class="w"> </span><span class="k">EACH</span><span class="w"> </span><span class="k">ROW</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">log_table</span><span class="w"> </span><span class="p">(</span><span class="n">operation_time</span><span class="k">,</span><span class="w"> </span><span class="n">new_value</span><span class="p">)</span>
<span class="w">    </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="s1">&#39;now&#39;</span><span class="p">),</span><span class="w"> </span><span class="k">NEW</span><span class="p">.</span><span class="k">column_name</span><span class="p">);</span>
<span class="k">END</span><span class="p">;</span>
</pre></div></div></div>

<h3>Проверка данных перед вставкой</h3>
<p>Если возраст меньше 18, вставка данных будет отменена</p>
<div class="code_element"><div class="lang_line"><text>sql</text><button class="copy_code_button" onclick="CopyCode(this)"><svg width="1.2em" height="1.2em" viewBox="0 0 24 24"><use href="#copy_code_svg"/></svg><text class="unselectable">Copy code</text></button></div><div class="code language-sql"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="n">validate_insert</span>
<span class="k">BEFORE</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">users</span>
<span class="k">FOR</span><span class="w"> </span><span class="k">EACH</span><span class="w"> </span><span class="k">ROW</span>
<span class="k">WHEN</span><span class="w"> </span><span class="k">NEW</span><span class="p">.</span><span class="n">age</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">18</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">RAISE</span><span class="p">(</span><span class="n">FAIL</span><span class="k">,</span><span class="w"> </span><span class="s1">&#39;Age must be 18 or above&#39;</span><span class="p">);</span>
<span class="k">END</span><span class="p">;</span>
</pre></div></div></div>

<h3>Ограничение изменения определённого столбца</h3>
<p>Запрещаем изменение столбца <code>salary</code></p>
<div class="code_element"><div class="lang_line"><text>sql</text><button class="copy_code_button" onclick="CopyCode(this)"><svg width="1.2em" height="1.2em" viewBox="0 0 24 24"><use href="#copy_code_svg"/></svg><text class="unselectable">Copy code</text></button></div><div class="code language-sql"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="n">prevent_salary_update</span>
<span class="k">BEFORE</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">OF</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">employees</span>
<span class="k">FOR</span><span class="w"> </span><span class="k">EACH</span><span class="w"> </span><span class="k">ROW</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">RAISE</span><span class="p">(</span><span class="n">FAIL</span><span class="k">,</span><span class="w"> </span><span class="s1">&#39;Salary cannot be updated&#39;</span><span class="p">);</span>
<span class="k">END</span><span class="p">;</span>
</pre></div></div></div>

<h3>Каскадное удаление</h3>
<p>При удалении строки из <code>parent_table</code> автоматически удаляются связанные строки в <code>child_table</code></p>
<div class="code_element"><div class="lang_line"><text>sql</text><button class="copy_code_button" onclick="CopyCode(this)"><svg width="1.2em" height="1.2em" viewBox="0 0 24 24"><use href="#copy_code_svg"/></svg><text class="unselectable">Copy code</text></button></div><div class="code language-sql"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="n">cascade_delete</span>
<span class="k">AFTER</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">parent_table</span>
<span class="k">FOR</span><span class="w"> </span><span class="k">EACH</span><span class="w"> </span><span class="k">ROW</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">DELETE</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">child_table</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">parent_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">OLD</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
<span class="k">END</span><span class="p">;</span>
</pre></div></div></div>

<h3>Логирование обновлений</h3>
<p>Логируется изменение значения столбца <code>column_name</code> в таблице <code>main_table</code></p>
<div class="code_element"><div class="lang_line"><text>sql</text><button class="copy_code_button" onclick="CopyCode(this)"><svg width="1.2em" height="1.2em" viewBox="0 0 24 24"><use href="#copy_code_svg"/></svg><text class="unselectable">Copy code</text></button></div><div class="code language-sql"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">update_log</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="n">AUTOINCREMENT</span><span class="k">,</span>
<span class="w">    </span><span class="n">old_value</span><span class="w"> </span><span class="nb">TEXT</span><span class="k">,</span>
<span class="w">    </span><span class="n">new_value</span><span class="w"> </span><span class="nb">TEXT</span><span class="k">,</span>
<span class="w">    </span><span class="n">updated_at</span><span class="w"> </span><span class="nb">TEXT</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="n">log_update</span>
<span class="k">AFTER</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">OF</span><span class="w"> </span><span class="k">column_name</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">main_table</span>
<span class="k">FOR</span><span class="w"> </span><span class="k">EACH</span><span class="w"> </span><span class="k">ROW</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">update_log</span><span class="w"> </span><span class="p">(</span><span class="n">old_value</span><span class="k">,</span><span class="w"> </span><span class="n">new_value</span><span class="k">,</span><span class="w"> </span><span class="n">updated_at</span><span class="p">)</span>
<span class="w">    </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="k">OLD</span><span class="p">.</span><span class="k">column_name</span><span class="k">,</span><span class="w"> </span><span class="k">NEW</span><span class="p">.</span><span class="k">column_name</span><span class="k">,</span><span class="w"> </span><span class="n">datetime</span><span class="p">(</span><span class="s1">&#39;now&#39;</span><span class="p">));</span>
<span class="k">END</span><span class="p">;</span>
</pre></div></div></div>

<h3>Триггер для представления</h3>
<p>Добавляем возможность вставлять данные в представление, что напрямую не поддерживается SQLite</p>
<div class="code_element"><div class="lang_line"><text>sql</text><button class="copy_code_button" onclick="CopyCode(this)"><svg width="1.2em" height="1.2em" viewBox="0 0 24 24"><use href="#copy_code_svg"/></svg><text class="unselectable">Copy code</text></button></div><div class="code language-sql"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">VIEW</span><span class="w"> </span><span class="n">view_name</span><span class="w"> </span><span class="k">AS</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">id</span><span class="k">,</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">main_table</span><span class="p">;</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="n">view_insert</span>
<span class="k">INSTEAD</span><span class="w"> </span><span class="k">OF</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">view_name</span>
<span class="k">FOR</span><span class="w"> </span><span class="k">EACH</span><span class="w"> </span><span class="k">ROW</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">main_table</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="k">,</span><span class="w"> </span><span class="n">name</span><span class="p">)</span>
<span class="w">    </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="k">NEW</span><span class="p">.</span><span class="n">id</span><span class="k">,</span><span class="w"> </span><span class="k">NEW</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
<span class="k">END</span><span class="p">;</span>
</pre></div></div></div>

<h1>Удаление триггеров</h1>
<div class="code_element"><div class="lang_line"><text>sql</text><button class="copy_code_button" onclick="CopyCode(this)"><svg width="1.2em" height="1.2em" viewBox="0 0 24 24"><use href="#copy_code_svg"/></svg><text class="unselectable">Copy code</text></button></div><div class="code language-sql"><div class="highlight"><pre><span></span><span class="k">DROP</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="k">trigger_name</span><span class="p">;</span>
</pre></div></div></div>

<h1>Особенности SQLite</h1>
<ul>
<li>Многострочные операции:
Триггеры в SQLite работают для каждой строки (<code>FOR EACH ROW</code>), но не поддерживают уровень операций (<code>FOR EACH STATEMENT</code>)</li>
<li>Отсутствие вложенных триггеров:
Если внутри триггера выполняется операция, которая вызывает другой триггер, SQLite запретит выполнение вложенных триггеров по умолчанию</li>
<li>Оптимизация условий:
Использование <code>WHEN</code> позволяет избежать выполнения ненужных операций</li>
</ul>
<h1>Советы и best practices</h1>
<ol>
<li>Минимизируйте логику триггеров:
Избегайте сложных операций, чтобы не замедлять вставки/обновления</li>
<li>Тестируйте:
Убедитесь, что триггеры работают как ожидается, особенно при граничных условиях</li>
<li>Документируйте:
Пишите комментарии для сложных триггеров, чтобы другие разработчики могли быстро понять логику</li>
<li>Логируйте изменения:
Логи полезны для отладки и анализа истории изменений данных</li>
</ol>
<h3>Проверка существующих триггеров</h3>
<p>Для просмотра списка триггеров в базе данных</p>
<div class="code_element"><div class="lang_line"><text>sql</text><button class="copy_code_button" onclick="CopyCode(this)"><svg width="1.2em" height="1.2em" viewBox="0 0 24 24"><use href="#copy_code_svg"/></svg><text class="unselectable">Copy code</text></button></div><div class="code language-sql"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">sqlite_master</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;trigger&#39;</span><span class="p">;</span>
</pre></div></div></div>

<p>Для получения SQL-кода триггера</p>
<div class="code_element"><div class="lang_line"><text>sql</text><button class="copy_code_button" onclick="CopyCode(this)"><svg width="1.2em" height="1.2em" viewBox="0 0 24 24"><use href="#copy_code_svg"/></svg><text class="unselectable">Copy code</text></button></div><div class="code language-sql"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="k">sql</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">sqlite_master</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;trigger&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;trigger_name&#39;</span><span class="p">;</span>
</pre></div></div></div>

<h2>---</h2>
<h2>---</h2>
<h2>---</h2>
<h1>Расширенные сценарии работы с триггерами</h1>
<h2>Использование нескольких условий в триггерах</h2>
<p>Иногда требуется более сложная логика проверки
Это можно реализовать в блоке <code>WHEN</code> или с помощью нескольких запросов в теле триггера</p>
<h3>Логирование только при определённом диапазоне значений</h3>
<p>Логируется только повышение зарплаты выше 100,000</p>
<div class="code_element"><div class="lang_line"><text>sql</text><button class="copy_code_button" onclick="CopyCode(this)"><svg width="1.2em" height="1.2em" viewBox="0 0 24 24"><use href="#copy_code_svg"/></svg><text class="unselectable">Copy code</text></button></div><div class="code language-sql"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="n">log_high_salary</span>
<span class="k">AFTER</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">OF</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">employees</span>
<span class="k">FOR</span><span class="w"> </span><span class="k">EACH</span><span class="w"> </span><span class="k">ROW</span>
<span class="k">WHEN</span><span class="w"> </span><span class="k">NEW</span><span class="p">.</span><span class="n">salary</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">100000</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="k">OLD</span><span class="p">.</span><span class="n">salary</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">100000</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">salary_log</span><span class="w"> </span><span class="p">(</span><span class="n">employee_id</span><span class="k">,</span><span class="w"> </span><span class="n">old_salary</span><span class="k">,</span><span class="w"> </span><span class="n">new_salary</span><span class="k">,</span><span class="w"> </span><span class="n">updated_at</span><span class="p">)</span>
<span class="w">    </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="k">NEW</span><span class="p">.</span><span class="n">id</span><span class="k">,</span><span class="w"> </span><span class="k">OLD</span><span class="p">.</span><span class="n">salary</span><span class="k">,</span><span class="w"> </span><span class="k">NEW</span><span class="p">.</span><span class="n">salary</span><span class="k">,</span><span class="w"> </span><span class="n">datetime</span><span class="p">(</span><span class="s1">&#39;now&#39;</span><span class="p">));</span>
<span class="k">END</span><span class="p">;</span>
</pre></div></div></div>

<h2>Триггеры на основе вычисляемых значений</h2>
<p>В триггере можно использовать функции и вычисления для обработки данных</p>
<h3>Обновление среднего значения в агрегатной таблице</h3>
<p>При добавлении нового результата обновляется средний балл студента</p>
<div class="code_element"><div class="lang_line"><text>sql</text><button class="copy_code_button" onclick="CopyCode(this)"><svg width="1.2em" height="1.2em" viewBox="0 0 24 24"><use href="#copy_code_svg"/></svg><text class="unselectable">Copy code</text></button></div><div class="code language-sql"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">scores</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="k">,</span>
<span class="w">    </span><span class="n">student_id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="k">,</span>
<span class="w">    </span><span class="n">score</span><span class="w"> </span><span class="nb">INTEGER</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">average_scores</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">student_id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="k">,</span>
<span class="w">    </span><span class="n">average_score</span><span class="w"> </span><span class="nb">REAL</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="n">update_average</span>
<span class="k">AFTER</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">scores</span>
<span class="k">FOR</span><span class="w"> </span><span class="k">EACH</span><span class="w"> </span><span class="k">ROW</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">average_scores</span><span class="w"> </span><span class="p">(</span><span class="n">student_id</span><span class="k">,</span><span class="w"> </span><span class="n">average_score</span><span class="p">)</span>
<span class="w">    </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="k">NEW</span><span class="p">.</span><span class="n">student_id</span><span class="k">,</span>
<span class="w">        </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">score</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">scores</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">student_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">NEW</span><span class="p">.</span><span class="n">student_id</span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="n">CONFLICT</span><span class="p">(</span><span class="n">student_id</span><span class="p">)</span>
<span class="w">    </span><span class="k">DO</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">average_score</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">score</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">scores</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">student_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">NEW</span><span class="p">.</span><span class="n">student_id</span><span class="p">);</span>
<span class="k">END</span><span class="p">;</span>
</pre></div></div></div>

<h2>Логика для ограничений на уровне таблицы</h2>
<p>Иногда триггеры могут использоваться как заменитель ограничений (<code>CHECK</code>), которые требуют сложных условий</p>
<h3>Ограничение на количество строк в таблице</h3>
<p>Таблица <code>user_logs</code> ограничивается 1000 строками. Если попытаться вставить новую строку, она вызовет ошибку</p>
<div class="code_element"><div class="lang_line"><text>sql</text><button class="copy_code_button" onclick="CopyCode(this)"><svg width="1.2em" height="1.2em" viewBox="0 0 24 24"><use href="#copy_code_svg"/></svg><text class="unselectable">Copy code</text></button></div><div class="code language-sql"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="n">limit_rows</span>
<span class="k">BEFORE</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">user_logs</span>
<span class="k">WHEN</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">user_logs</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1000</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">RAISE</span><span class="p">(</span><span class="n">FAIL</span><span class="k">,</span><span class="w"> </span><span class="s1">&#39;Log table cannot exceed 1000 rows&#39;</span><span class="p">);</span>
<span class="k">END</span><span class="p">;</span>
</pre></div></div></div>

<h2>Каскадное обновление связанных таблиц</h2>
<p>Можно автоматически обновлять данные в связанных таблицах при изменении основной таблицы</p>
<h3>Обновление связанного имени</h3>
<p>При изменении имени сотрудника в таблице <code>employees</code> автоматически обновляется его имя в таблице <code>projects</code></p>
<div class="code_element"><div class="lang_line"><text>sql</text><button class="copy_code_button" onclick="CopyCode(this)"><svg width="1.2em" height="1.2em" viewBox="0 0 24 24"><use href="#copy_code_svg"/></svg><text class="unselectable">Copy code</text></button></div><div class="code language-sql"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="n">cascade_name_update</span>
<span class="k">AFTER</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">OF</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">employees</span>
<span class="k">FOR</span><span class="w"> </span><span class="k">EACH</span><span class="w"> </span><span class="k">ROW</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">projects</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">manager_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">NEW</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">manager_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">OLD</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
<span class="k">END</span><span class="p">;</span>
</pre></div></div></div>

<h2>Автоматическая генерация уникальных значений</h2>
<p>Триггеры могут использоваться для генерации уникальных идентификаторов или значений</p>
<h3>Генерация кода для новой записи</h3>
<p>При вставке новой записи автоматически генерируется уникальный код на основе максимального ID</p>
<div class="code_element"><div class="lang_line"><text>sql</text><button class="copy_code_button" onclick="CopyCode(this)"><svg width="1.2em" height="1.2em" viewBox="0 0 24 24"><use href="#copy_code_svg"/></svg><text class="unselectable">Copy code</text></button></div><div class="code language-sql"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="n">AUTOINCREMENT</span><span class="k">,</span>
<span class="w">    </span><span class="n">order_code</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">UNIQUE</span><span class="k">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="nb">TEXT</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="n">generate_order_code</span>
<span class="k">BEFORE</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">orders</span>
<span class="k">FOR</span><span class="w"> </span><span class="k">EACH</span><span class="w"> </span><span class="k">ROW</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="k">NEW</span><span class="p">.</span><span class="n">order_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;ORD-&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">MAX</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="p">);</span>
<span class="k">END</span><span class="p">;</span>
</pre></div></div></div>

<h2>Работа с INSTEAD OF триггерами</h2>
<blockquote>
<p>[!NOTE]
<code>INSTEAD OF</code> используется для представлений или случаев, когда стандартное поведение требуется переопределить</p>
</blockquote>
<h3>Вставка в представление</h3>
<p>Добавляем возможность вставки в представление <code>employee_projects</code></p>
<div class="code_element"><div class="lang_line"><text>sql</text><button class="copy_code_button" onclick="CopyCode(this)"><svg width="1.2em" height="1.2em" viewBox="0 0 24 24"><use href="#copy_code_svg"/></svg><text class="unselectable">Copy code</text></button></div><div class="code language-sql"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">VIEW</span><span class="w"> </span><span class="n">employee_projects</span><span class="w"> </span><span class="k">AS</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">employee_id</span><span class="k">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">employee_name</span><span class="k">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">project_name</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">projects</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">manager_id</span><span class="p">;</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="n">insert_into_view</span>
<span class="k">INSTEAD</span><span class="w"> </span><span class="k">OF</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">employee_projects</span>
<span class="k">FOR</span><span class="w"> </span><span class="k">EACH</span><span class="w"> </span><span class="k">ROW</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="k">,</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="k">NEW</span><span class="p">.</span><span class="n">employee_id</span><span class="k">,</span><span class="w"> </span><span class="k">NEW</span><span class="p">.</span><span class="n">employee_name</span><span class="p">);</span>
<span class="w">    </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">projects</span><span class="w"> </span><span class="p">(</span><span class="n">manager_id</span><span class="k">,</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="k">NEW</span><span class="p">.</span><span class="n">employee_id</span><span class="k">,</span><span class="w"> </span><span class="k">NEW</span><span class="p">.</span><span class="n">project_name</span><span class="p">);</span>
<span class="k">END</span><span class="p">;</span>
</pre></div></div></div>

<h2>Отладка триггеров</h2>
<h3>Просмотр SQL-кода триггера</h3>
<div class="code_element"><div class="lang_line"><text>sql</text><button class="copy_code_button" onclick="CopyCode(this)"><svg width="1.2em" height="1.2em" viewBox="0 0 24 24"><use href="#copy_code_svg"/></svg><text class="unselectable">Copy code</text></button></div><div class="code language-sql"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">name</span><span class="k">,</span><span class="w"> </span><span class="k">sql</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">sqlite_master</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;trigger&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;trigger_name&#39;</span><span class="p">;</span>
</pre></div></div></div>

<h3>Временное отключение триггеров</h3>
<p>SQLite не поддерживает явное отключение триггеров, но можно временно удалить их</p>
<div class="code_element"><div class="lang_line"><text>sql</text><button class="copy_code_button" onclick="CopyCode(this)"><svg width="1.2em" height="1.2em" viewBox="0 0 24 24"><use href="#copy_code_svg"/></svg><text class="unselectable">Copy code</text></button></div><div class="code language-sql"><div class="highlight"><pre><span></span><span class="k">DROP</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="k">trigger_name</span><span class="p">;</span>
</pre></div></div></div>

<h3>Тестирование триггеров</h3>
<p>Используйте транзакции для проверки</p>
<div class="code_element"><div class="lang_line"><text>sql</text><button class="copy_code_button" onclick="CopyCode(this)"><svg width="1.2em" height="1.2em" viewBox="0 0 24 24"><use href="#copy_code_svg"/></svg><text class="unselectable">Copy code</text></button></div><div class="code language-sql"><div class="highlight"><pre><span></span><span class="k">BEGIN</span><span class="w"> </span><span class="k">TRANSACTION</span><span class="p">;</span>
<span class="c1">-- Выполняем тестовые операции</span>
<span class="k">ROLLBACK</span><span class="p">;</span>
</pre></div></div></div>

<h3>Логирование</h3>
<p>Добавьте дополнительную таблицу для логирования операций триггера</p>
<div class="code_element"><div class="lang_line"><text>sql</text><button class="copy_code_button" onclick="CopyCode(this)"><svg width="1.2em" height="1.2em" viewBox="0 0 24 24"><use href="#copy_code_svg"/></svg><text class="unselectable">Copy code</text></button></div><div class="code language-sql"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">trigger_logs</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="k">trigger_name</span><span class="w"> </span><span class="nb">TEXT</span><span class="k">,</span>
<span class="w">  </span><span class="n">action_time</span><span class="w"> </span><span class="nb">TEXT</span><span class="k">,</span>
<span class="w">  </span><span class="n">details</span><span class="w"> </span><span class="nb">TEXT</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="n">log_test_trigger</span>
<span class="k">AFTER</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">some_table</span>
<span class="k">FOR</span><span class="w"> </span><span class="k">EACH</span><span class="w"> </span><span class="k">ROW</span>
<span class="k">BEGIN</span>
<span class="w">  </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">trigger_logs</span><span class="w"> </span><span class="p">(</span><span class="k">trigger_name</span><span class="k">,</span><span class="w"> </span><span class="n">action_time</span><span class="k">,</span><span class="w"> </span><span class="n">details</span><span class="p">)</span>
<span class="w">  </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;log_test_trigger&#39;</span><span class="k">,</span><span class="w"> </span><span class="n">datetime</span><span class="p">(</span><span class="s1">&#39;now&#39;</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;Inserted row into some_table&#39;</span><span class="p">);</span>
<span class="k">END</span><span class="p">;</span>
</pre></div></div></div>

<h2>Советы и рекомендации</h2>
<ol>
<li>Ограничивайте сложность триггеров:
Если бизнес-логика слишком сложна, лучше переместить её на уровень приложения</li>
<li>Избегайте циклических триггеров:
Убедитесь, что триггеры не вызывают друг друга, иначе это приведёт к ошибке</li>
<li>Используйте <code>WHEN</code> для оптимизации:
Проверяйте условие выполнения триггера, чтобы избежать ненужных операций</li>
<li>Минимизируйте побочные эффекты:
Триггеры не должны изменять состояние, о котором не известно вызывающему процессу</li>
<li>Регулярно тестируйте:
Проверяйте работу триггеров после изменения структуры базы данных</li>
</ol>