`PRAGMA` механизм для настройки и диагностики SQLite

Используется для:

- Управления поведением базы данных
- Получения информации о структуре и состоянии
- Включения/выключения служебных режимов

# Синтаксис

```sql
PRAGMA имя_параметра;
PRAGMA имя_параметра = значение;
PRAGMA имя_параметра(аргументы);
```

### Информация о структуре базы данных

| Команда                                 | Назначение                                           |
|-----------------------------------------|------------------------------------------------------|
| `PRAGMA table_info(имя_таблицы);`       | Информация о столбцах таблицы: имя, тип, ограничения |
| `PRAGMA index_list(имя_таблицы);`       | Список индексов таблицы                              |
| `PRAGMA index_info(имя_индекса);`       | Информация о полях, покрываемых индексом             |
| `PRAGMA table_list;`                    | Список всех таблиц и временных таблиц                |
| `PRAGMA foreign_key_list(имя_таблицы);` | Список внешних ключей таблицы                        |
| `PRAGMA database_list;`                 | Список подключённых баз данных (main, temp и т.д.)   |

### Управление ссылочной целостностью

| Команда                     | Назначение                                                |
|-----------------------------|-----------------------------------------------------------|
| `PRAGMA foreign_keys = ON;` | Включает проверку внешних ключей (по умолчанию выключено) |
| `PRAGMA foreign_keys;`      | Показывает, включены ли внешние ключи (0 или 1)           |

Рекомендуется включать **сразу после подключения к БД**

### Журналирование и безопасность

| Команда                            | Назначение                                                                                        |
|------------------------------------|---------------------------------------------------------------------------------------------------|
| `PRAGMA journal_mode;`             | Показывает текущий режим журналирования (`DELETE`, `WAL`, `MEMORY`, `OFF`, `TRUNCATE`, `PERSIST`) |
| `PRAGMA journal_mode = WAL;`       | Устанавливает режим WAL - быстрая многопоточность и надёжность                                    |
| `PRAGMA synchronous = FULL;`       | Контроль синхронизации с диском: `OFF`, `NORMAL`, `FULL`, `EXTRA`                                 |
| `PRAGMA locking_mode = EXCLUSIVE;` | Позволяет работать с БД без блокировок от других соединений                                       |

### Производительность и оптимизация

| Команда                       | Назначение                                                                      |
|-------------------------------|---------------------------------------------------------------------------------|
| `PRAGMA temp_store = MEMORY;` | Временные таблицы хранятся в памяти                                             |
| `PRAGMA cache_size = -N;`     | Размер кэша в килобайтах (отрицательное значение) или страницах (положительное) |
| `PRAGMA page_size;`           | Размер страницы БД (по умолчанию 4096 байт)                                     |
| `PRAGMA optimize;`            | Запускает оптимизацию - пересчёт статистики, удаление мёртвых индексов          |
| `PRAGMA analysis_limit = N;`  | Ограничение на анализ строк в `ANALYZE`                                         |

### Диагностика и отладка

| Команда                       | Назначение                                       |
|-------------------------------|--------------------------------------------------|
| `PRAGMA integrity_check;`     | Проверка целостности базы данных                 |
| `PRAGMA quick_check;`         | Быстрая, менее полная версия integrity\_check    |
| `PRAGMA schema_version;`      | Версия схемы базы (увеличивается при изменениях) |
| `PRAGMA encoding;`            | Кодировка БД (обычно UTF-8)                      |
| `PRAGMA compile_options;`     | Список опций компиляции SQLite                   |
| `PRAGMA busy_timeout = 5000;` | Время ожидания (в мс), если БД занята            |

### Работа с транзакциями и autovacuum

| Команда                             | Назначение                                             |
|-------------------------------------|--------------------------------------------------------|
| `PRAGMA auto_vacuum = FULL;`        | Включает автоматическую очистку неиспользуемых страниц |
| `PRAGMA wal_autocheckpoint = 1000;` | Порог страниц WAL перед авто-чекпоинтом                |
| `PRAGMA locking_mode;`              | Текущий режим блокировки: `NORMAL`, `EXCLUSIVE`        |

# Примеры полезного использования

### Включение внешних ключей

```sql
PRAGMA foreign_keys = ON;
```

### Перевод БД в WAL-режим

```sql
PRAGMA journal_mode = WAL;
```

### Проверка структуры таблицы

```sql
PRAGMA table_info(users);
```

### Оптимизация после массового изменения

```sql
PRAGMA optimize;
```

# Рекомендации

- Включай внешние ключи: SQLite по умолчанию их игнорирует
- Используй WAL, если ты работаешь с многопоточностью или веб-приложением
- Делай PRAGMA optimize после большого количества изменений
- Вызывай integrity\_check при подозрении на повреждение базы
