## **`unittest.mock`**: имитация объектов

**`unittest.mock`** — это мощная библиотека, встроенная в `unittest`, для замены объектов в ваших тестах.
Она позволяет подменять зависимости, чтобы изолировать тестируемый код от внешних систем
(например, базы данных, веб-сервисы, файлы) и тестировать логику в более контролируемой среде.

### Основные компоненты

| Компонент              | Описание                                                                                                          | Пример использования                                              |
|------------------------|-------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------|
| `Mock()`               | Создает имитацию объекта (mock),<br>который можно настраивать, как угодно                                         | `mock_obj = Mock()`                                               |
| `patch()`              | Контекстный менеджер или декоратор для замены объектов<br>(например, функций или классов) на mock во время тестов | `with patch("module.ClassName") as MockClass: ...`                |
| `assert_called()`      | Проверяет, был ли вызван mock                                                                                     | `mock_obj.assert_called()`                                        |
| `assert_called_once()` | Проверяет, что mock был вызван ровно один раз                                                                     | `mock_obj.assert_called_once()`                                   |
| `assert_called_with()` | Проверяет, что mock был вызван с определенными аргументами                                                        | `mock_obj.assert_called_with(10, key="value")`                    |
| `side_effect`          | Позволяет mock возвращать разные значения при каждом<br>вызове или выбрасывать исключения                         | `mock_obj.side_effect = [1, 2, 3]`                                |
| `return_value`         | Значение, которое будет возвращено при вызове mock                                                                | `mock_obj.return_value = 42`                                      |
| `call_count`           | Количество вызовов mock                                                                                           | `mock_obj.call_count == 2`                                        |
| `patch.object()`       | Заменяет атрибут объекта (например, метод)                                                                        | `with patch.object(SomeClass, "method_name") as mock_method: ...` |

### Пример использования `Mock`

```python
from unittest.mock import Mock

# Создание mock-объекта
mock_obj = Mock()

# Настройка возвращаемого значения
mock_obj.some_method.return_value = "Mocked result"

# Вызов mock-метода
result = mock_obj.some_method()

# Проверка вызова
mock_obj.some_method.assert_called_once()
print(result)  # Выведет "Mocked result"
```

### Пример использования `patch`

```python
from unittest import TestCase
from unittest.mock import patch

class TestExternalDependency(TestCase):
    @patch("module_with_dependency.external_function")
    def test_external_function_mock(self, mock_external_function):
        # Настройка возвращаемого значения
        mock_external_function.return_value = 10

        # Вызов функции, которая использует external_function
        result = some_function()

        # Проверка вызова mock
        mock_external_function.assert_called_once()
        self.assertEqual(result, 10)
```

### `patch()` как декоратор

```python
@patch("module_with_dependency.ClassName")
def test_class_mock(self, MockClass):
    mock_instance = MockClass.return_value
    mock_instance.method.return_value = "Mocked"

    result = mock_instance.method()
    self.assertEqual(result, "Mocked")
```

### `side_effect` для имитации исключений или возвращаемых значений

```python
from unittest.mock import Mock

mock_func = Mock()

# Сценарий: возвращаем разные значения при каждом вызове
mock_func.side_effect = [1, 2, 3]

print(mock_func())  # 1
print(mock_func())  # 2
print(mock_func())  # 3

# Сценарий: выброс исключения
mock_func.side_effect = ValueError("Some error")
try:
    mock_func()
except ValueError as e:
    print(e)  # "Some error"
```

## Дополнительные возможности `unittest`

### Запуск тестов с параметрами командной строки

Вы можете использовать различные параметры при запуске `unittest` для изменения поведения тестов

- **Запуск тестов в verbose-режиме** (подробный вывод)
```bash
python -m unittest -v test_module.py
```

- **Запуск тестов в quiet-режиме** (минимальный вывод)
```bash
python -m unittest -q test_module.py
```

- **Остановка на первом неудачном тесте**
```bash
python -m unittest -f test_module.py
```

### Организация тестов с помощью Test Suites

Test Suite позволяет группировать несколько тестов для более гибкой организации их выполнения

```python
import unittest


# Определение тестовых классов
class TestClassA(unittest.TestCase):
    def test_case_a(self):
        self.assertEqual(1, 1)

class TestClassB(unittest.TestCase):
    def test_case_b(self):
        self.assertTrue(True)

# Создание тестовой группы
def suite():
    suite = unittest.TestSuite()
    suite.addTest(TestClassA("test_case_a"))
    suite.addTest(TestClassB("test_case_b"))
    return suite

# Запуск тестов
if __name__ == "__main__":
    runner = unittest.TextTestRunner()
    runner.run(suite())
```

### Тестирование исключений

Вы можете проверять, выбрасывает ли код определенные исключения, с помощью `assertRaises`

```python
import unittest

class TestExceptions(unittest.TestCase):

    def test_exception(self):
        with self.assertRaises(ValueError):
            raise ValueError("Это исключение")
```

### Тестирование с временем ожидания (таймаут)

Для тестов, которые могут работать слишком долго, можно задать таймаут с помощью `timeout` параметра

```python
import unittest


class TestTimeout(unittest.TestCase):
    @unittest.timeout(1)  # 1 секунда
    def test_timeout(self):
        while True:  # Этот тест завершится по таймауту
            pass
```

### Дополнительные библиотеки для тестирования

- **`pytest`** — альтернатива `unittest`, поддерживающая функции, не требующие классов для тестов, и имеющая мощные плагины.
- **`nose2`** — инструмент, который расширяет возможности `unittest` и имеет поддержку плагинов.
- **`hypothesis`** — библиотека для создания тестов на основе свойств (property-based testing),
где тесты автоматически проверяют множество входных данных.

Эта расширенная шпаргалка включает не только базовую работу с `unittest`, но и подробное описание возможностей `unittest.mock`
и других дополнительных возможностей для эффективного тестирования кода на Python.

---

# Методы

| Метод                       | Описание                                                                                                                                                                                                                                                                                                                                 |
|-----------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `assert_called()`           | Проверяет, был ли вызван мок-объект хотя бы один раз                                                                                                                                                                                                                                                                                     |
| `assert_called_once()`      | Проверяет, был ли вызван мок-объект ровно один раз                                                                                                                                                                                                                                                                                       |
| `assert_called_with()`      | Проверяет, был ли вызван мок-объект с указанными аргументами                                                                                                                                                                                                                                                                             |
| `assert_called_once_with()` | Проверяет, был ли вызван мок-объект ровно один раз с указанными аргументами                                                                                                                                                                                                                                                              |
| `assert_not_called()`       | Проверяет, что мок-объект не был вызван                                                                                                                                                                                                                                                                                                  |
| `assert_called_once()`      | Проверяет, что мок-объект был вызван только один раз                                                                                                                                                                                                                                                                                     |
| `return_value`              | Устанавливает значение, которое будет возвращено мок-объектом при вызове                                                                                                                                                                                                                                                                 |
| `side_effect`               | Устанавливает функцию, которая будет вызываться вместо мок-объекта при вызове,<br>позволяет эмулировать различное поведение в зависимости от переданных аргументов                                                                                                                                                                       |
| `reset_mock()`              | Сбрасывает состояние мок-объекта, сбрасывая информацию о вызовах методов и аргументах                                                                                                                                                                                                                                                    |
| `assert_has_calls()`        | Проверяет последовательность вызовов мок-объекта в соответствии с переданным списком вызовов                                                                                                                                                                                                                                             |
| `side_effect`               | Может быть функцией или итерируемым объектом, который определяет поведение мок-объекта при вызове.<br>В функции side_effect можно реализовать пользовательскую логику, возвращать различные значения или вызывать исключения.<br>Для итерируемого объекта side_effect мок-объект будет возвращать значения в порядке элементов итератора |
| `patch()`                   | Используется в качестве контекстного менеджера (with) или декоратора, чтобы временно заменить объекты на моки.<br>Позволяет заменить модули, классы, функции, методы, атрибуты и т. д. внутри определенной области видимости                                                                                                             |
| `start()`                   | Метод контекстного менеджера patch(), начинает временную замену объектов на моки                                                                                                                                                                                                                                                         |
| `stop()`                    | Метод контекстного менеджера patch(), завершает временную замену объектов на моки                                                                                                                                                                                                                                                        |
| `return_value`              | Атрибут, который задает значение, которое будет возвращено при вызове метода или доступе к атрибуту мок-объекта                                                                                                                                                                                                                          |
| `side_effect`               | Атрибут, который задает функцию, которая будет вызываться при вызове метода<br>или доступе к атрибуту мок-объекта вместо реального поведения                                                                                                                                                                                             |
| `return_value`              | Позволяет установить значение, которое будет возвращено при вызове метода или доступе к атрибуту мок-объекта                                                                                                                                                                                                                             |
| `side_effect`               | Позволяет установить функцию, которая будет вызываться при вызове метода<br>или доступе к атрибуту мок-объекта, заменяя реальное поведение                                                                                                                                                                                               |

| Методы экземпляра mock.Mock()                    | Описание                                                                                                                                                           |
|--------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `unittest.mock.Mock().assert_called()`           | Проверяет, был ли вызван мок-объект хотя бы один раз                                                                                                               |
| `unittest.mock.Mock().assert_called_once()`      | Проверяет, был ли вызван мок-объект ровно один раз                                                                                                                 |
| `unittest.mock.Mock().assert_called_with()`      | Проверяет, был ли вызван мок-объект с указанными аргументами                                                                                                       |
| `unittest.mock.Mock().assert_called_once_with()` | Проверяет, был ли вызван мок-объект ровно один раз с указанными аргументами                                                                                        |
| `unittest.mock.Mock().assert_not_called()`       | Проверяет, что мок-объект не был вызван                                                                                                                            |
| `unittest.mock.Mock().assert_called_once()`      | Проверяет, что мок-объект был вызван только один раз                                                                                                               |
| `unittest.mock.Mock().return_value`              | Устанавливает значение, которое будет возвращено мок-объектом при вызове                                                                                           |
| `unittest.mock.Mock().side_effect`               | Устанавливает функцию, которая будет вызываться вместо мок-объекта при вызове,<br>позволяет эмулировать различное поведение в зависимости от переданных аргументов |
| `unittest.mock.Mock().reset_mock()`              | Сбрасывает состояние мок-объекта, сбрасывая информацию о вызовах методов и аргументах                                                                              |
| `unittest.mock.Mock().assert_has_calls()`        | Проверяет последовательность вызовов мок-объекта в соответствии с переданным списком вызовов                                                                       |


| Методы модуля unittest.mock  | Описание                                                                                                                                                                                                                     |
|------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `unittest.mock.patch()`      | Используется в качестве контекстного менеджера (with) или декоратора, чтобы временно заменить объекты на моки.<br>Позволяет заменить модули, классы, функции, методы, атрибуты и т. д. внутри определенной области видимости |
| `unittest.mock.start()`      | Метод контекстного менеджера patch(), начинает временную замену объектов на моки                                                                                                                                             |
| `unittest.mock.stop()`       | Метод контекстного менеджера patch(), завершает временную замену объектов на моки                                                                                                                                            |
| `unittest.mock.return_value` | Атрибут, который задает значение, которое будет возвращено при вызове метода или доступе к атрибуту мок-объекта                                                                                                              |
| `unittest.mock.side_effect`  | Атрибут, который задает функцию, которая будет вызываться при вызове метода<br>или доступе к атрибуту мок-объекта вместо реального поведения                                                                                 |
| `unittest.mock.return_value` | Позволяет установить значение, которое будет возвращено при вызове метода или доступе к атрибуту мок-объекта                                                                                                                 |
| `unittest.mock.side_effect`  | Позволяет установить функцию, которая будет вызываться при вызове метода<br>или доступе к атрибуту мок-объекта, заменяя реальное поведение                                                                                   |
