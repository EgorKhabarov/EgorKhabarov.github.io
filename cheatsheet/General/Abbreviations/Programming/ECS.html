<h1>ECS</h1>
<p><strong>ECS (Entity-Component-System)</strong> - это шаблон проектирования, в котором данные и логика строго разделены:</p>
<ul>
<li><strong>Entity (Сущность)</strong> Уникальный идентификатор объекта</li>
<li><strong>Component (Компонент)</strong> Структура данных, описывающая аспект поведения или состояния</li>
<li><strong>System (Система)</strong> Логика, работающая с группами сущностей по наличию компонентов</li>
</ul>
<p>Такой подход особенно популярен в игровых движках и симуляциях</p>
<h2>Компоненты</h2>
<p>Компоненты - это простые классы или структуры, содержащие только данные (никакой логики)</p>
<div class="code_element"><div class="lang_line"><text>python</text><button class="copy_code_button" onclick="CopyCode(this)"><svg style="width: 1.2em;height: 1.2em;" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 4h3a1 1 0 0 1 1 1v15a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1h3m0 3h6m-5-4v4h4V3h-4Z"/></svg><text class="unselectable">Copy code</text></button></div><div class="code language-python"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Position</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="k">,</span> <span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="k">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Velocity</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="k">,</span> <span class="n">dx</span><span class="o">=</span><span class="mi">0</span><span class="k">,</span> <span class="n">dy</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">=</span> <span class="n">dx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dy</span> <span class="o">=</span> <span class="n">dy</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Health</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="k">,</span> <span class="n">hp</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hp</span> <span class="o">=</span> <span class="n">hp</span>
</pre></div></div></div>

<h2>Сущности</h2>
<p>Сущность - просто уникальный ID (обычно <code>int</code> или <code>uuid.UUID</code>).</p>
<div class="code_element"><div class="lang_line"><text>python</text><button class="copy_code_button" onclick="CopyCode(this)"><svg style="width: 1.2em;height: 1.2em;" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 4h3a1 1 0 0 1 1 1v15a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1h3m0 3h6m-5-4v4h4V3h-4Z"/></svg><text class="unselectable">Copy code</text></button></div><div class="code language-python"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>

<span class="k">class</span><span class="w"> </span><span class="nc">EntityManager</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_id_gen</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_entity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id_gen</span><span class="p">)</span>
</pre></div></div></div>

<h3>Хранилище компонентов</h3>
<p>Используем словари, чтобы хранить компоненты по типу и привязке к сущностям</p>
<div class="code_element"><div class="lang_line"><text>python</text><button class="copy_code_button" onclick="CopyCode(this)"><svg style="width: 1.2em;height: 1.2em;" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 4h3a1 1 0 0 1 1 1v15a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1h3m0 3h6m-5-4v4h4V3h-4Z"/></svg><text class="unselectable">Copy code</text></button></div><div class="code language-python"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">World</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">components</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># {ComponentType: {entity_id: component}}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_component</span><span class="p">(</span><span class="bp">self</span><span class="k">,</span> <span class="n">entity</span><span class="k">,</span> <span class="n">component</span><span class="p">):</span>
        <span class="n">ctype</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">component</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ctype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">ctype</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">ctype</span><span class="p">][</span><span class="n">entity</span><span class="p">]</span> <span class="o">=</span> <span class="n">component</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_component</span><span class="p">(</span><span class="bp">self</span><span class="k">,</span> <span class="n">component_type</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">component_type</span><span class="k">,</span> <span class="p">{})</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_entity_components</span><span class="p">(</span><span class="bp">self</span><span class="k">,</span> <span class="n">entity</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">ctype</span><span class="p">:</span> <span class="n">comps</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ctype</span><span class="k">,</span> <span class="n">comps</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">comps</span>
        <span class="p">}</span>
</pre></div></div></div>

<h2>Системы</h2>
<p>Система перебирает сущности, у которых есть нужные компоненты, и применяет к ним поведение</p>
<h3>Система перемещения</h3>
<div class="code_element"><div class="lang_line"><text>python</text><button class="copy_code_button" onclick="CopyCode(this)"><svg style="width: 1.2em;height: 1.2em;" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 4h3a1 1 0 0 1 1 1v15a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1h3m0 3h6m-5-4v4h4V3h-4Z"/></svg><text class="unselectable">Copy code</text></button></div><div class="code language-python"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MovementSystem</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="k">,</span> <span class="n">world</span><span class="k">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">Position</span><span class="p">)</span>
        <span class="n">velocities</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">Velocity</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">velocities</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span>
                <span class="n">vel</span> <span class="o">=</span> <span class="n">velocities</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span>
                <span class="n">pos</span><span class="o">.</span><span class="n">x</span> <span class="o">+=</span> <span class="n">vel</span><span class="o">.</span><span class="n">dx</span> <span class="o">*</span> <span class="n">dt</span>
                <span class="n">pos</span><span class="o">.</span><span class="n">y</span> <span class="o">+=</span> <span class="n">vel</span><span class="o">.</span><span class="n">dy</span> <span class="o">*</span> <span class="n">dt</span>
</pre></div></div></div>

<h3>Система урона</h3>
<div class="code_element"><div class="lang_line"><text>python</text><button class="copy_code_button" onclick="CopyCode(this)"><svg style="width: 1.2em;height: 1.2em;" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 4h3a1 1 0 0 1 1 1v15a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1h3m0 3h6m-5-4v4h4V3h-4Z"/></svg><text class="unselectable">Copy code</text></button></div><div class="code language-python"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DamageSystem</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="k">,</span> <span class="n">world</span><span class="p">):</span>
        <span class="n">healths</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">Health</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">entity</span><span class="k">,</span> <span class="n">health</span> <span class="ow">in</span> <span class="n">healths</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">health</span><span class="o">.</span><span class="n">hp</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">health</span><span class="o">.</span><span class="n">hp</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Entity </span><span class="si">{</span><span class="n">entity</span><span class="si">}</span><span class="s2"> is dead&quot;</span><span class="p">)</span>
</pre></div></div></div>

<h1>Использование</h1>
<div class="code_element"><div class="lang_line"><text>python</text><button class="copy_code_button" onclick="CopyCode(this)"><svg style="width: 1.2em;height: 1.2em;" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 4h3a1 1 0 0 1 1 1v15a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1h3m0 3h6m-5-4v4h4V3h-4Z"/></svg><text class="unselectable">Copy code</text></button></div><div class="code language-python"><div class="highlight"><pre><span></span><span class="c1"># Создание мира и сущностей</span>
<span class="n">world</span> <span class="o">=</span> <span class="n">World</span><span class="p">()</span>
<span class="n">entities</span> <span class="o">=</span> <span class="n">EntityManager</span><span class="p">()</span>

<span class="n">player</span> <span class="o">=</span> <span class="n">entities</span><span class="o">.</span><span class="n">create_entity</span><span class="p">()</span>
<span class="n">enemy</span> <span class="o">=</span> <span class="n">entities</span><span class="o">.</span><span class="n">create_entity</span><span class="p">()</span>

<span class="c1"># Назначение компонентов</span>
<span class="n">world</span><span class="o">.</span><span class="n">add_component</span><span class="p">(</span><span class="n">player</span><span class="k">,</span> <span class="n">Position</span><span class="p">(</span><span class="mi">0</span><span class="k">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">world</span><span class="o">.</span><span class="n">add_component</span><span class="p">(</span><span class="n">player</span><span class="k">,</span> <span class="n">Velocity</span><span class="p">(</span><span class="mi">1</span><span class="k">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">world</span><span class="o">.</span><span class="n">add_component</span><span class="p">(</span><span class="n">player</span><span class="k">,</span> <span class="n">Health</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>

<span class="n">world</span><span class="o">.</span><span class="n">add_component</span><span class="p">(</span><span class="n">enemy</span><span class="k">,</span> <span class="n">Position</span><span class="p">(</span><span class="mi">5</span><span class="k">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">world</span><span class="o">.</span><span class="n">add_component</span><span class="p">(</span><span class="n">enemy</span><span class="k">,</span> <span class="n">Health</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

<span class="c1"># Создание систем</span>
<span class="n">movement</span> <span class="o">=</span> <span class="n">MovementSystem</span><span class="p">()</span>
<span class="n">damage</span> <span class="o">=</span> <span class="n">DamageSystem</span><span class="p">()</span>

<span class="c1"># Цикл обновления</span>
<span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">movement</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">world</span><span class="k">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">damage</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">world</span><span class="p">)</span>
</pre></div></div></div>

<h1>Расширение</h1>
<p>Ты можешь добавить:</p>
<ul>
<li><strong>Фильтрацию сущностей</strong>: метод <code>get_entities_with(*component_types)</code></li>
<li><strong>Удаление компонентов и сущностей</strong></li>
<li><strong>События</strong> и <strong>сигналы</strong></li>
<li><strong>Системы с приоритетами</strong></li>
<li><strong>Система тегов/группировки</strong></li>
</ul>
<h1>Преимущества</h1>
<ul>
<li>Высокая производительность при правильной реализации</li>
<li>Гибкость и масштабируемость</li>
<li>Чёткое разделение данных и логики</li>
</ul>
<h1>Недостатки</h1>
<ul>
<li>Непривычная парадигма для тех, кто привык к ООП</li>
<li>Повышенная сложность без фреймворка</li>
<li>Могут быть проблемы с отладкой при большой вложенности</li>
</ul>
<h3>Фильтрация по компонентам</h3>
<div class="code_element"><div class="lang_line"><text>python</text><button class="copy_code_button" onclick="CopyCode(this)"><svg style="width: 1.2em;height: 1.2em;" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 4h3a1 1 0 0 1 1 1v15a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1h3m0 3h6m-5-4v4h4V3h-4Z"/></svg><text class="unselectable">Copy code</text></button></div><div class="code language-python"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_entities_with</span><span class="p">(</span><span class="n">world</span><span class="k">,</span> <span class="o">*</span><span class="n">component_types</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">component_types</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">()</span>

    <span class="n">sets</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="n">world</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">component_types</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="o">*</span><span class="n">sets</span><span class="p">)</span>
</pre></div></div></div>

<div class="code_element"><div class="lang_line"><text>python</text><button class="copy_code_button" onclick="CopyCode(this)"><svg style="width: 1.2em;height: 1.2em;" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 4h3a1 1 0 0 1 1 1v15a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1h3m0 3h6m-5-4v4h4V3h-4Z"/></svg><text class="unselectable">Copy code</text></button></div><div class="code language-python"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">get_entities_with</span><span class="p">(</span><span class="n">world</span><span class="k">,</span> <span class="n">Position</span><span class="k">,</span> <span class="n">Health</span><span class="p">):</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">Position</span><span class="p">)[</span><span class="n">entity</span><span class="p">]</span>
    <span class="n">hp</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">Health</span><span class="p">)[</span><span class="n">entity</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Entity </span><span class="si">{</span><span class="n">entity</span><span class="si">}</span><span class="s2"> is at (</span><span class="si">{</span><span class="n">pos</span><span class="o">.</span><span class="n">x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">pos</span><span class="o">.</span><span class="n">y</span><span class="si">}</span><span class="s2">) with HP </span><span class="si">{</span><span class="n">hp</span><span class="o">.</span><span class="n">hp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div></div></div>